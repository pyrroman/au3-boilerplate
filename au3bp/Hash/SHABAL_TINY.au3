; -----------------------------------------------------------------------------
; SHABAL_TINY Hash Machine Code UDF
; Purpose: Provide The Machine Code Version of SHABAL Hash Algorithm In AutoIt
; Author: Ward
; -----------------------------------------------------------------------------

#Include-once
#Include <Memory.au3>

Global $_SHABAL_TINY_CodeBuffer, $_SHABAL_TINY_CodeBufferMemory
Global $_SHABAL_TINY_InitOffset, $_SHABAL_TINY_InputOffset, $_SHABAL_TINY_ResultOffset

Func _SHABAL_TINY_Exit()
	$_SHABAL_TINY_CodeBuffer = 0
	_MemVirtualFree($_SHABAL_TINY_CodeBufferMemory, 0, $MEM_RELEASE)
EndFunc

Func _SHABAL_TINY_Startup()
	If Not IsDllStruct($_SHABAL_TINY_CodeBuffer) Then
		If @AutoItX64 Then
			Local $Opcode = '0x89DBE91002000087DBE9D402000009DB4989D14531C031D2E94C0100005731C056538B1481015481784883C0014883F81075EF8B81FC0000003141488B81F800000031414C31C0C14C81780F4883C0014883F81075F1448B41744531C931D2BE3800000031DB904D8D59104989F241C1C8114929D2488D420D478D04804183E20F46334499084889D746338491B800000083E70F83E00F8B4481783304B94C8D52094983C1014183E20F478D04404431C04C8D42064183E00F468B44817841F7D046234491784C8D571C4431C0468B44910841C1C81F41F7D04131C04983F90C4C0F44CB4883C20146894491084883FA3042894499084189C00F8568FFFFFF8B81D0000000BA25000000014174BE0B000000B80A0000004889D383E30F8B9C99B8000000015C8148488D58FF4885C04889F0480F45C34883EA014883FA0275D731C08B9481B80000002B14818B5C817889548178899C81B80000004883C0014883F81075DD5B5E5FC3564C89CE41B980000000534889CB4883EC28488B41404489C141D3F941B8400000004489C9F7D921D131D24409C9880C034883C001488D0C034929C0E8E10100004889D9E86BFEFFFF4889D9E863FEFFFF4889D9E85BFEFFFF4889D9E853FEFFFF8B8300010000C1E80585C07439BA2C00000029C283E8014C8D44860489D083C2018B44834889C18806C1E908884E0189C1C1E818C1E910884603884E024883C6044C39C675D64883C4285B5EC35731C05689D6534889CB4883EC20C7440348000000004883C004483DB000000075ECB90800000030C04889DFF348AB89F289F789D188140383C201C1E908884C03014883C0044883F84075E7C783FC000000FFFFFFFFC783F8000000FFFFFFFF4889D9E89EFDFFFF8D5610448D462083C7104889D889D183C201408838C1E90883C7018848014883C0044439C275E6C783FC00000000000000C783F8000000000000004889D9E85BFDFFFF89B300010000C783FC0000000100000048C74340000000004883C4205B5E5FC3415541544989CC554889D557564C89C6534883EC284D85C0488B5940746841BD40000000EB054885F6745B4C89EF498D0C1C4889EA4829DF4839F7480F47FE4989F84801FB4801FDE84B0000004829FE4883FB4075D04C89E130DBE8DBFCFFFF418B8424FC00000083C00185C041898424FC00000075AF41838424F8000000014885F675A69049895C24404883C4285B5E5F5D415C415DC356574889CF4889D64C89C1FCF3A45F5EC3574889CF4889D04C89C1FCF3AA5FC3'
		Else
			Local $Opcode = '0x89DB83EC088B442410894424048B44240C890424E83902000083C408C2100087DB83EC1C8B442428894424088B442424894424048B442420890424E8DD02000083C41CC2100009DB83EC1C8B442424C744240800000000C7442404000000008944240C8B442420890424E83901000083C41CC210005531D257565383EC048B0C90014C907483C20183FA1075F18B90F80000003150448B90F400000031504831D2C14C90740F83C20183FA1075F38B587031F631C989CABD3800000083E20F29CD8914248B3C248D510D83E20F83E50F8B549074C1CB118D1C9B3314B88D7E1083C601335CB804339CA8B40000008D690983E50F8D1C5B31DA8D590683E30F8B5C9874F7D3235CA8748B2C2431DA83C51C8B5CA804C1CB1FF7D331D3895CA80431DB83FE0C0F94C383C10183EB0121DE83F9308954B80489D30F8576FFFFFF8B90CC000000B925000000015070BA0A000000EB0A83E901B20B83F902741F89CB83E30F8B9C98B4000000015C904485D274E283E90183EA0183F90275E131D28B5C90748B8C90B40000002B0C90899C90B4000000894C907483C20183FA1075DF83C4045B5E5F5DC356BA800000005383EC148B4C24288B5C2420D3FA89D18B4340F7D9224C242409D1BA40000000880C0383C00129C28D040389542408C744240400000000890424E8F901000089D8E881FEFFFF89D8E87AFEFFFF89D8E873FEFFFF89D8E86CFEFFFF8B93FC000000C1EA0585D27436B83C00000029D08D4C83048B44242C8D34908B1183C10489D3C1EB0888580189D38810C1EB10C1EA1888580288500383C00439F075DC83C4145B5EC35531C057565383EC048B5C24188B74241CC74483440000000083C00183F82C75F0B91000000030C089DF89F2F3AB89F789D1C1E90888148383C201884C830183C00183F81075E989D8C783F8000000FFFFFFFF8D6E20C783F4000000FFFFFFFFE8BEFDFFFF8D4710884424038D561089D80FB64C240389D783C201C1EF08880889F988480183C004804424030139EA75E0C783F80000000000000089D8C783F400000000000000E877FDFFFFC783F800000001000000C743400000000089B3FC00000083C4045B5E5F5DC35557565383EC1C8B4424308B6C24348B7C24388B704085FF745CBB4000000029F339FB760289FB8B44243029DF896C240401DD895C240801F001DE890424E84200000083FE4075CE8B4424306631F6E804FDFFFF8B5424308B82F800000083C00185C08982F800000075AB8382F40000000185FF75A48B54243089724083C41C5B5E5F5DC356578B7C240C8B7424108B4C241485C9742FFC83F9087227F7C7010000007402A449F7C702000000740566A583E90289CAC1E902F3A589D183E103F3A4EB02F3A45F5EC3578B4C241085C974300FB644240C69C0010101018B7C2408F7C703000000740AAA49F7C70300000075F689CAC1E902FCF3AB89D183E103F3AA5FC3'
		EndIf
		$_SHABAL_TINY_InitOffset = (StringInStr($Opcode, "89DB") - 3) / 2
		$_SHABAL_TINY_InputOffset = (StringInStr($Opcode, "87DB") - 3) / 2
		$_SHABAL_TINY_ResultOffset = (StringInStr($Opcode, "09DB") - 3) / 2
		$Opcode = Binary($Opcode)

		$_SHABAL_TINY_CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
		$_SHABAL_TINY_CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $_SHABAL_TINY_CodeBufferMemory)
		DllStructSetData($_SHABAL_TINY_CodeBuffer, 1, $Opcode)
		OnAutoItExitRegister("_SHABAL_TINY_Exit")
	EndIf
EndFunc

Func _SHABAL_TINYInit($Size = 512)
	$Size = Floor($Size / 32) * 32
	If $Size < 32 Then $Size = 32
	If $Size > 512 Then $Size = 512
	If Not IsDllStruct($_SHABAL_TINY_CodeBuffer) Then _SHABAL_TINY_Startup()

	Local $Context = DllStructCreate("byte buf[64]; ptr ptr; uint state[44]; uint W[2]; uint out_size")
	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_SHABAL_TINY_CodeBuffer) + $_SHABAL_TINY_InitOffset, _
													"ptr", DllStructGetPtr($Context), _
													"int", $Size, _
													"int", 0, _
													"int", 0)

	Return $Context
EndFunc


Func _SHABAL_TINYInput(ByRef $Context, $Data)
	If Not IsDllStruct($_SHABAL_TINY_CodeBuffer) Then _SHABAL_TINY_Startup()
	If Not IsDllStruct($Context) Then Return SetError(1, 0, 0)

	$Data = Binary($Data)
	Local $InputLen = BinaryLen($Data)
	Local $Input = DllStructCreate("byte[" & $InputLen & "]")
	DllStructSetData($Input, 1, $Data)
	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_SHABAL_TINY_CodeBuffer) + $_SHABAL_TINY_InputOffset, _
													"ptr", DllStructGetPtr($Context), _
													"ptr", DllStructGetPtr($Input), _
													"uint", $InputLen, _
													"int", 0)
EndFunc


Func _SHABAL_TINYResult(ByRef $Context)
	If Not IsDllStruct($_SHABAL_TINY_CodeBuffer) Then _SHABAL_TINY_Startup()
	If Not IsDllStruct($Context) Then Return SetError(1, 0, "")

	Local $Digest = DllStructCreate("byte[" & (DllStructGetData($Context, "out_size") / 8) & "]")

	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_SHABAL_TINY_CodeBuffer) + $_SHABAL_TINY_ResultOffset, _
													"ptr", DllStructGetPtr($Context), _
													"ptr", DllStructGetPtr($Digest), _
													"int", 0, _
													"int", 0)
	Return DllStructGetData($Digest, 1)
EndFunc


Func _SHABAL_TINY($Data, $Size = 512)
	Local $Context = _SHABAL_TINYInit($Size)
	_SHABAL_TINYInput($Context, $Data)
	Return _SHABAL_TINYResult($Context)
EndFunc
