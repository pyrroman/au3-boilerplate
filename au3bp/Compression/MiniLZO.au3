; -----------------------------------------------------------------------------
; MiniLZO Compression Machine Code UDF
; Purpose: Provide The Machine Code Version of MiniLZO Algorithm In AutoIt
; Author: Ward
; MiniLZO Copyright (C) 1996-2008 Markus Franz Xaver Johannes Oberhumer
; -----------------------------------------------------------------------------

#Include-once
#Include <Memory.au3>

Global $_MiniLZO_CodeBuffer, $_MiniLZO_CodeBufferMemory
Global $_MiniLZO_Compress, $_MiniLZO_Decompress

Func _MiniLZO_Exit()
	$_MiniLZO_CodeBuffer = 0
	_MemVirtualFree($_MiniLZO_CodeBufferMemory, 0, $MEM_RELEASE)
EndFunc

Func _MiniLZO_Startup()
	If Not IsDllStruct($_MiniLZO_CodeBuffer) Then
		If @AutoItX64 Then
			Local $Code = 'KAkAAIkAwEiD7DhMi0l4EOhBeAj/6CQgxxIJTYPBSQ406NgDHDA+xDjD/tujJtnHRLg8YQPotARMGUF3V3yNZxFYz5ZWaH7GP1VMP2w+8zxUP1ezU2UYookNq5gKcE5BBKFeeAO884A3ietC8N2B5f9uB5Xm9R+xxkY07zx+Fgw5ynIopMPmKR7TdCADgfv/vxs2dxcTgggBD4aWg3lEOkoD0YSMhhVNOcWOZAYsmFi+wET0tv4DxQtQAg+JYDgIQAFmQRrRCQfaSMHiBkcxfBRYZAEXBTIYmwoyhNMU4wYBD0HrDJc/rZCRmMiQUYccdlMKjA2FMP8C2LcaBWY7GHQ5ETiYxodoMYGY+8wrdJIDSIsIMngaMIQICJY+/gAp2FteX11BXOW8CHbyw8CWUgJ1wUwxOfh3dDXhKZ4Qg/G4h8lV3AabRv4sbsV82QbzVOEDzIPGAcGIA5QOw9B7e+0fdetJ2cYGx480WgNNjcAB+Doc1kEjpxY+YuhGicJL0Cuk+rePdzPjg+sBm+pRhtpXBNr3HwNA4wdFiF4BPoneA+YCCfJB2xYkRMZGAznoc0UFdMfpo/4QyDwgQIORggEMeAKoQ8ogpCv0QhuNFJ3dhploBtlMIUVCcruBt8Pp9qKL00AS5oiNWGT9Qh5CAekiSialpVwQt7yBAjhaBCBSRawU/wgDgQUCMRT/CASBBgIdFP8IBYEHAgkU/wgGgQgC9aF9wgnr7wcyGjoYdX0bUzvAJAg7j4ly6iojIKHkZa8ky1jhRPohKndz7ofqDekRv5BS65DXN9s5xeMSDE89C6HLEAnTStdxonMD5+5B4waFHxEmPbGvdhiQEuuRGLF36Fg5EosxOyD66iFEERC0K29O0JAyiPpSMJN+/oWislgJESZjeWbbhftbnkNjfCi9VfExzVcI11aJTM5TKZ6b4SB2DWnPtQWkhI2mMsEGIOgW/L302CZMA3cFhcB0gbkpx2As/fY9Vu7NSaV2Y2INEnexjVAk1BCBwFezYDnYdePIIhHslMHJzMIFfH1PocXCQIg6TIBM6bvKwOA4blKWHK8bMRe6Aq/lEgzkKeSJgspnZCawawcIQP7rufyk7tBbIVIGkINXGkYY1B5CjJ0x+tDp9koSEOVJx2kBO6PeFBEsLlyKuticEhBNXwFffG6xlGzwZ+xkpyhcFTCgrwE8SBESIpTXFg8qweWNcMEUY/aMFP4DLgjZk2LwIBrLyX7CpnAb2k3D9SAahNpE6E3MyjDSHGYxOAMOZ0sr+KN3XmEaFcHoApg6Wiz32Jije4R3/6CcweHvkrTJDVzIVerrnViTrpkOWtNREBOYEEItcf4ug+ZvlI6RygGU7PzaoloHkccIshQ/BaIzm8MkzwX5lAKOk1nh3NsAfBr/yHAZSwj0gAxj2+TfzCAfMGofAkUxanVDX0k+TAHbaBUkdB+AdVkaizEcZoXbIdgIikzKGiiOQYRy/8eUVRVAi41uUxCNWYMgFCbdKOgV9RICLIdDkBRoEC37kFNuJJF8kRzIuJzqIDTpQ6GVaZi/i6CrjWj/mWMEJu1F0xz92xt17jpNqPMkMdKJ/QNmFc847+H2RItk1z1Sg3R+RfIzzBPGCf9MAwpqDAlO8AmNDIUx/gTjlQQI99nDfsL3NsMiG2wp/MUisFDZ0QbZIALQoZ05IipIry44K29q7sEZ7GLqAOvpKKEoBdJGc9VEUwaE23TvDutGDpw9RBjNcoWJ+FWPRijYPbi6fGShnIjVA9R15XzrgPgfob3aF5bgEiKEuf63kZsJAmYstRbbkbFMUwWBVZLlTMGsKfu5IND2jmJFIYsfQYdo4mlLBJoQZwiRIBogx4sqbB/5+dN5Gv2aE8MJgod36UkGBhgcj5DbN8PU6UBEbB2TBwiQ/WkoBrQh/agEajuVBFqCAW79PwQf6S8kkZp2NzWMk5TXDYMI/tELNXIA8Ad0X6/ssCxMOdcsdF6+F+8hsOkIM1YpGbCgUqJCKeZKDWMueIiZuZbYKCdAiULQ6dxX/JLgB+uMF00pwh9j'
				$Code &= 'CznRADQRdAgZ9UKI/EIUhR6LyQjWLQpiBX+E/wn+KcTpwAA='
		Else
			Local $Code = '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'
				$Code &= 'O1VIenZYmGvSlglqCIFYCyndIBkHjO8ayAd4ie+RG8kAlTnPdDMuge9/Qena/im/KhjY01dIGVQ0wMcWmKS1RFLDhln3lFGBme/8TK80ug9RCtNwzwQWdAgZBBTi/NUHgA0UidCcYAxdwwA='
 		EndIf
		Local $Opcode = String(_MiniLZO_CodeDecompress($Code))
		$_MiniLZO_Compress = (StringInStr($Opcode, "89C0") - 3) / 2
		$_MiniLZO_Decompress = (StringInStr($Opcode, "89DB") - 3) / 2
		$Opcode = Binary($Opcode)

		$_MiniLZO_CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
		$_MiniLZO_CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $_MiniLZO_CodeBufferMemory)
		DllStructSetData($_MiniLZO_CodeBuffer, 1, $Opcode)
		OnAutoItExitRegister("_MiniLZO_Exit")
	EndIf
EndFunc

Func _MiniLZO_Compress_Core($Data)
	If Not IsDllStruct($_MiniLZO_CodeBuffer) Then _MiniLZO_Startup()

	$Data = Binary($Data)
	Local $InputLen = BinaryLen($Data)
	Local $Input = DllStructCreate("byte[" & $InputLen & "]")
	DllStructSetData($Input, 1, $Data)

	Local $OutputLen = $InputLen + 1024
	Local $Output = DllStructCreate("byte[" & $OutputLen & "]")
	Local $Buffer = DllStructCreate("byte[131072]")

	Local $Ptr = DllStructCreate("ptr src; ptr dst; ptr buf")
	DllStructSetData($Ptr, 'src', DllStructGetPtr($Input))
	DllStructSetData($Ptr, 'dst', DllStructGetPtr($Output))
	DllStructSetData($Ptr, 'buf', DllStructGetPtr($Buffer))

	Local $Ret = DllCall("user32.dll", "uint", "CallWindowProc", "ptr", DllStructGetPtr($_MiniLZO_CodeBuffer) + $_MiniLZO_Compress, _
													"ptr", DllStructGetPtr($Ptr), _
													"uint", $InputLen, _
													"uint*", $OutputLen, _
													"int", 0)


	Return BinaryMid(DllStructGetData($Output, 1), 1, $Ret[4])
EndFunc

Func _MiniLZO_Decompress_Core($Data, $MaxBuffer)
	If Not IsDllStruct($_MiniLZO_CodeBuffer) Then _MiniLZO_Startup()

	$Data = Binary($Data)
	Local $InputLen = BinaryLen($Data)
	Local $Input = DllStructCreate("byte[" & $InputLen & "]")
	DllStructSetData($Input, 1, $Data)

	Local $Output = DllStructCreate("byte[" & $MaxBuffer & "]")

	$Ret = DllCall("user32.dll", "uint", "CallWindowProc", "ptr", DllStructGetPtr($_MiniLZO_CodeBuffer) + $_MiniLZO_Decompress, _
													"ptr", DllStructGetPtr($Input), _
													"uint", $InputLen, _
													"ptr", DllStructGetPtr($Output), _
													"uint*", $MaxBuffer)

	Return BinaryMid(DllStructGetData($Output, 1), 1, $Ret[5])
EndFunc

Func _MiniLZO_Compress($Data)
	If Not IsDllStruct($_MiniLZO_CodeBuffer) Then _MiniLZO_Startup()

	$Data = Binary($Data)
	Local $InputLen = BinaryLen($Data)
	Return BinaryMid(Binary($InputLen), 1, 4) & _MiniLZO_Compress_Core($Data)
EndFunc

Func _MiniLZO_Decompress($Data)
	If Not IsDllStruct($_MiniLZO_CodeBuffer) Then _MiniLZO_Startup()

	$Data = Binary($Data)
	Local $OutputLen = Int(BinaryMid($Data, 1, 4))
	Return _MiniLZO_Decompress_Core(BinaryMid($Data, 5), $OutputLen)
EndFunc

Func _MiniLZO_CodeDecompress($Code)
	If @AutoItX64 Then
		Local $Opcode = '0x89C04150535657524889CE4889D7FCB28031DBA4B302E87500000073F631C9E86C000000731D31C0E8630000007324B302FFC1B010E85600000010C073F77544AAEBD3E85600000029D97510E84B000000EB2CACD1E8745711C9EB1D91FFC8C1E008ACE8340000003D007D0000730A80FC05730783F87F7704FFC1FFC141904489C0B301564889FE4829C6F3A45EEB8600D275078A1648FFC610D2C331C9FFC1E8EBFFFFFF11C9E8E4FFFFFF72F2C35A4829D7975F5E5B4158C389D24883EC08C70100000000C64104004883C408C389F64156415541544D89CC555756534C89C34883EC20410FB64104418800418B3183FE010F84AB00000073434863D24D89C54889CE488D3C114839FE0F84A50100000FB62E4883C601E8C601000083ED2B4080FD5077E2480FBEED0FB6042884C00FBED078D3C1E20241885500EB7383FE020F841C01000031C083FE03740F4883C4205B5E5F5D415C415D415EC34863D24D89C54889CE488D3C114839FE0F84CA0000000FB62E4883C601E86401000083ED2B4080FD5077E2480FBEED0FB6042884C078D683E03F410845004983C501E964FFFFFF4863D24D89C54889CE488D3C114839FE0F84E00000000FB62E4883C601E81D01000083ED2B4080FD5077E2480FBEED0FB6042884C00FBED078D389D04D8D7501C1E20483E03041885501C1F804410845004839FE747B0FB62E4883C601E8DD00000083ED2B4080FD5077E6480FBEED0FB6042884C00FBED078D789D0C1E2064D8D6E0183E03C41885601C1F8024108064839FE0F8536FFFFFF41C7042403000000410FB6450041884424044489E84883C42029D85B5E5F5D415C415D415EC34863D24889CE4D89C6488D3C114839FE758541C7042402000000410FB60641884424044489F04883C42029D85B5E5F5D415C415D415EC341C7042401000000410FB6450041884424044489E829D8E998FEFFFF41C7042400000000410FB6450041884424044489E829D8E97CFEFFFF56574889CF4889D64C89C1FCF3A45F5EC3E8500000003EFFFFFF3F3435363738393A3B3C3DFFFFFFFEFFFFFF000102030405060708090A0B0C0D0E0F10111213141516171819FFFFFFFFFFFF1A1B1C1D1E1F202122232425262728292A2B2C2D2E2F3031323358C3'
	Else
		Local $Opcode = '0x89C0608B7424248B7C2428FCB28031DBA4B302E86D00000073F631C9E864000000731C31C0E85B0000007323B30241B010E84F00000010C073F7753FAAEBD4E84D00000029D97510E842000000EB28ACD1E8744D11C9EB1C9148C1E008ACE82C0000003D007D0000730A80FC05730683F87F770241419589E8B3015689FE29C6F3A45EEB8E00D275058A164610D2C331C941E8EEFFFFFF11C9E8E7FFFFFF72F2C32B7C2428897C241C61C389D28B442404C70000000000C6400400C2100089F65557565383EC1C8B6C243C8B5424388B5C24308B7424340FB6450488028B550083FA010F84A1000000733F8B5424388D34338954240C39F30F848B0100000FB63B83C301E8CD0100008D57D580FA5077E50FBED20FB6041084C00FBED078D78B44240CC1E2028810EB6B83FA020F841201000031C083FA03740A83C41C5B5E5F5DC210008B4C24388D3433894C240C39F30F84CD0000000FB63B83C301E8740100008D57D580FA5077E50FBED20FB6041084C078DA8B54240C83E03F080283C2018954240CE96CFFFFFF8B4424388D34338944240C39F30F84D00000000FB63B83C301E82E0100008D57D580FA5077E50FBED20FB6141084D20FBEC278D78B4C240C89C283E230C1FA04C1E004081189CF83C70188410139F374750FB60383C3018844240CE8EC0000000FB654240C83EA2B80FA5077E00FBED20FB6141084D20FBEC278D289C283E23CC1FA02C1E006081739F38D57018954240C8847010F8533FFFFFFC74500030000008B4C240C0FB60188450489C82B44243883C41C5B5E5F5DC210008D34338B7C243839F3758BC74500020000000FB60788450489F82B44243883C41C5B5E5F5DC210008B54240CC74500010000000FB60288450489D02B442438E9B1FEFFFFC7450000000000EB9956578B7C240C8B7424108B4C241485C9742FFC83F9087227F7C7010000007402A449F7C702000000740566A583E90289CAC1E902F3A589D183E103F3A4EB02F3A45F5EC3E8500000003EFFFFFF3F3435363738393A3B3C3DFFFFFFFEFFFFFF000102030405060708090A0B0C0D0E0F10111213141516171819FFFFFFFFFFFF1A1B1C1D1E1F202122232425262728292A2B2C2D2E2F3031323358C3'
	EndIf
	Local $AP_Decompress = (StringInStr($Opcode, "89C0") - 3) / 2
	Local $B64D_Init = (StringInStr($Opcode, "89D2") - 3) / 2
	Local $B64D_DecodeData = (StringInStr($Opcode, "89F6") - 3) / 2
	$Opcode = Binary($Opcode)

	Local $CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
	Local $CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $CodeBufferMemory)
	DllStructSetData($CodeBuffer, 1, $Opcode)

	Local $B64D_State = DllStructCreate("byte[16]")
	Local $Length = StringLen($Code)
	Local $Output = DllStructCreate("byte[" & $Length & "]")

	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($CodeBuffer) + $B64D_Init, _
													"ptr", DllStructGetPtr($B64D_State), _
													"int", 0, _
													"int", 0, _
													"int", 0)

	DllCall("user32.dll", "int", "CallWindowProc", "ptr", DllStructGetPtr($CodeBuffer) + $B64D_DecodeData, _
													"str", $Code, _
													"uint", $Length, _
													"ptr", DllStructGetPtr($Output), _
													"ptr", DllStructGetPtr($B64D_State))

	Local $ResultLen = DllStructGetData(DllStructCreate("uint", DllStructGetPtr($Output)), 1)
	Local $Result = DllStructCreate("byte[" & ($ResultLen + 16) & "]")

	Local $Ret = DllCall("user32.dll", "uint", "CallWindowProc", "ptr", DllStructGetPtr($CodeBuffer) + $AP_Decompress, _
													"ptr", DllStructGetPtr($Output) + 4, _
													"ptr", DllStructGetPtr($Result), _
													"int", 0, _
													"int", 0)


	_MemVirtualFree($CodeBufferMemory, 0, $MEM_RELEASE)
	Return BinaryMid(DllStructGetData($Result, 1), 1, $Ret[0])
EndFunc
