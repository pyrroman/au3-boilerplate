; -----------------------------------------------------------------------------
; XXTEA Machine Code UDF
; Purpose: Provide The Machine Code Version of XXTEA Algorithm In AutoIt
; Author: Ward
; -----------------------------------------------------------------------------

#Include-once
#Include <Memory.au3>

Global $_XTEnc_CodeBuffer, $_XTEnc_CodeBufferMemory
Global $_XTDec_CodeBuffer, $_XTDec_CodeBufferMemory

Func _XTEnc_Exit()
	$_XTEnc_CodeBuffer = 0
	_MemVirtualFree($_XTEnc_CodeBufferMemory, 0, $MEM_RELEASE)
EndFunc

Func _XTDec_Exit()
	$_XTDec_CodeBuffer = 0
	_MemVirtualFree($_XTDec_CodeBufferMemory, 0, $MEM_RELEASE)
EndFunc

Func _XXTEA_Encrypt($Key, $Data)
	If Not IsDllStruct($_XTEnc_CodeBuffer) Then
		If @AutoItX64 Then
			Local $Opcode = '0x4157415641554154555756534883EC184189D44863C24C8D4C81FC458B11BA3400000089D0C1FA1F41F7FC8D500685D20F8EE000000069C0B979379E2DAA25B34A89442404BD000000004183EC0148894C240841BF0000000081ED4786C8614189ED41C1ED024183E5034589E6488B4424084489FA4585E47F054589FEEB4F8B58044889D64C31EE83E6034489D741333CB089EE31DE8D34374589D341C1E30489DFC1EF034431DF41C1EA05C1E3024131DA468D14174431D64189F244031044891083C2014883C0044439E27CB18B014D31F54183E5034489D343331CA889EA31C28D14134489D6C1E60489C3C1EB0331F341C1EA05C1E0024131C2428D04134189D24131C24503114589113B6C24040F8543FFFFFFB8000000004883C4185B5E5F5D415C415D415E415FC3'
		Else
			Local $Opcode = '0x5557565383EC1C8B4C24308B5C2434895C24088D4499FC8944240C8B30BA3400000089D0C1FA1FF7FB8D500685D20F8EE500000089F269C0B979379E2DAA25B34A89442418C704240000000083EB01895C2414812C244786C8618B0424C1E80283E003894424048B74241489742410B80100000085F67F0AC744241000000000EB498B1C818D70FF83E6033374240489D78B6C2438337CB5008B342431DE8D343789D5C1E50489DFC1EF0331EFC1EA05C1E30231DA8D141731F2035481FC895481FC83C0013B44240875B78B018B5C241083E303335C24048B7424388B1C9E31D38B342431C68D3C3389D3C1E30489C6C1EE0331F3C1EA05C1E00231C28D141331FA8B6C240C0355008955008B4424183904240F853AFFFFFFB80000000083C41C5B5E5F5DC21000'
		EndIf
		$Opcode = Binary($Opcode)

		$_XTEnc_CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
		$_XTEnc_CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $_XTEnc_CodeBufferMemory)
		DllStructSetData($_XTEnc_CodeBuffer, 1, $Opcode)
		OnAutoItExitRegister("_XTEnc_Exit")
	EndIf

	$Data = Binary($Data)
	Local $DataLen = BinaryLen($Data)
	If $DataLen = 0 Then
		Return SetError(1, 0, Binary(""))
	ElseIf $DataLen < 8 Then
		$DataLen = 8
	EndIf

	Local $V = DllStructCreate("byte[" & Ceiling($DataLen / 4) * 4 & "]")
	DllStructSetData($V, 1, $Data)

	Local $K = DllStructCreate("byte[16]")
	DllStructSetData($K, 1, $Key)

	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_XTEnc_CodeBuffer), _
													"ptr", DllStructGetPtr($V), _
													"uint", Ceiling($DataLen / 4), _
													"ptr", DllStructGetPtr($K), _
													"int", 0)

	Return DllStructGetData($V, 1)
EndFunc

Func _XXTEA_Decrypt($Key, $Data)
	If Not IsDllStruct($_XTDec_CodeBuffer) Then
		If @AutoItX64 Then
			Local $Opcode = '0x41554154555756534883EC084189D1448B11BA3400000089D0C1FA1F41F7F983C00669D8B979379E85DB0F84BA0000004963C1488D7C81FC418D69FF89DEC1EE0283E60389E885ED7E574C63D8428B5499FC4E8D1C994989C14931F14183E1034189D4473324884589D14131D9478D0C0C4189D541C1E5044589D441C1EC034531ECC1EA0541C1E2024431D2418D14144431CA458B134129D245891383E80175A98B174831F083E00389D6413334804489D031D88D04064589D141C1E90389D6C1E6044431CE41C1E202C1EA054431D28D141631C2448B114129D244891181C34786C8610F8552FFFFFFB8000000004883C4085B5E5F5D415C415DC3'
		Else
			Local $Opcode = '0x5557565383EC1C8B4C24348B4424308B18BA3400000089D0C1FA1FF7F983C00669C0B979379E8944240485C00F84EC00000089D88B5424308D548AFC895424108D59FF895C240C8D51FEC1E2020354243089542414C1E302895C24188B542404C1EA0283E203895424088B54240C85D27E5A8B7424148B4C2430034C24188B1E89D783E703337C24088B6C24388B7CBD0031DF893C248B7C240431C7033C24893C2489C5C1ED0389DFC1E70431EFC1E002C1EB0531D801C7333C248B0129F8890183EE0483E90483EA0175B28B5C24108B0B83E2033354240889CB8B742438331C968B54240431C28D141389C6C1EE0389CBC1E30431F3C1E002C1E90531C88D040331C28B6C24308B450029D0894500814424044786C8610F853EFFFFFFB80000000083C41C5B5E5F5DC21000'
		EndIf
		$Opcode = Binary($Opcode)

		$_XTDec_CodeBufferMemory = _MemVirtualAlloc(0, BinaryLen($Opcode), $MEM_COMMIT, $PAGE_EXECUTE_READWRITE)
		$_XTDec_CodeBuffer = DllStructCreate("byte[" & BinaryLen($Opcode) & "]", $_XTDec_CodeBufferMemory)
		DllStructSetData($_XTDec_CodeBuffer, 1, $Opcode)
		OnAutoItExitRegister("_XTDec_Exit")
	EndIf

	$Data = Binary($Data)
	Local $DataLen = BinaryLen($Data)
	If $DataLen = 0 Then Return SetError(1, 0, Binary(""))

	Local $V = DllStructCreate("byte[" & Ceiling($DataLen / 4) * 4 & "]")
	DllStructSetData($V, 1, $Data)

	Local $K = DllStructCreate("byte[16]")
	DllStructSetData($K, 1, $Key)

	DllCall("user32.dll", "none", "CallWindowProc", "ptr", DllStructGetPtr($_XTDec_CodeBuffer), _
													"ptr", DllStructGetPtr($V), _
													"uint", Ceiling($DataLen / 4), _
													"ptr", DllStructGetPtr($K), _
													"int", 0)

	Return DllStructGetData($V, 1)
EndFunc

Func _XXTEA_Encrypt_Pad($Key, $Data)
	$Data = Binary($Data)
	Local $DataLen = BinaryLen($Data), $DataPad

	Switch(Mod($DataLen, 4))
	Case 0
		$DataPad = Binary("0x80000000")
	Case 1
		$DataPad = Binary("0x800000")
	Case 2
		$DataPad = Binary("0x8000")
	Case 3
		$DataPad = Binary("0x80")
	EndSwitch
	Return _XXTEA_Encrypt($Key, $Data & $DataPad)
EndFunc

Func _XXTEA_Decrypt_Pad($Key, $Data)
	$Data = _XXTEA_Decrypt($Key, $Data)
	Local $DataLen = BinaryLen($Data), $i
	For $i = $DataLen To $DataLen - 8 Step -1
		If BinaryMid($Data, $i, 1) = Binary("0x80") Then
			$Data = BinaryMid($Data, 1, $i - 1)
			ExitLoop
		EndIf
	Next
	Return $Data
EndFunc
